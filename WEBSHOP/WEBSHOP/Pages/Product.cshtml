@page
@model WEBSHOP.Pages.ProductModel
@{
}

<div id="MainDiv">
    <div class="text-center">
        <label id="MainLabel" class="font-weight-normal fs-1">
            Product`s catalog
            @if (User.IsInRole(UserStatus.Admin.ToString()))
            {
                <i class="bi bi-plus-circle link-success" data-createpartial="@Url.PageLink("/Product","DataToCreatePartial")"></i>
            }
        </label>
    </div>
    <br />
    <br />

    <div id="prodList" class="row" style="justify-content:center">
        @foreach (var prod in Model.ProductList)
        {
            <div id="ProdToSell_@prod.Id" class="col-lg-4" style="height:600px">
                <div class="card">
                    <div class="card-header text-center">
                        <label class="card-title fs-3">@prod.Title</label>
                    </div>
                    <div class="card-img text-center">
                        <img src="~/Imgs/1.png" width="300" height="300" />
                    </div>
                    <div class="card-body">
                        <div class="col">
                            <div class="row">
                                <div class="col text-center">
                                    <label class="card-text">Cost:</label>
                                    <label class="card-text">@prod.Cost</label>
                                </div>
                            </div>
                            <div class="row text-center">
                                <div class="col">
                                    <label class="card-text">Quantity:</label>
                                    <label class="card-text">@prod.Quantity</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="row text-center" style="justify-content:center">
                            <div class="col">
                                <form method="post" asp-page="/Bin" asp-page-handler="Create" asp-route-prod_id="@prod.Id">
                                    <button type="submit" class="btn btn-outline-success"><i class="bi bi-box-arrow-in-up-right"></i> To cart</button>
                                </form>
                            </div>
                            @if (User.IsInRole("Admin") || User.IsInRole("Employee"))
                            {
                                <div class="col">
                                    <button type="button" id="AddToOrderById_@prod.Id" class="btn btn-outline-secondary" data-productid="@prod.Id" data-url="@Url.Page("Orders","ShowOrders")">To order</button>
                                </div>
                            }
                            @if (User.IsInRole("Admin"))
                            {
                                <div class="col">
                                    <button type="button" class="btn btn-outline-warning" data-url="@Url.Page("Product","DataToEditPartial",new ProductViewModel
                        {
                            Id = prod.Id,
                            Title = prod.Title,
                            Cost = prod.Cost,
                            Quantity = prod.Quantity,
                            ProductManufactorer = prod.ProductManufactorer,
                            ProductUnit = prod.ProductUnit,
                            ProductType = prod.ProductType
                        })">
                                        <i class="bi bi-pencil-square"></i> Edit
                                    </button>
                                </div>
                                <div class="col">
                                    <button type="button" class="btn btn-outline-danger" asp-page="Product" asp-page-handler="Delete" asp-route-Id="@prod.Id"
                                    data-delConfPart="/Product?Id=@prod.Id&handler=ToDelete">
                                        <i class="bi bi-trash3"></i> Delete
                                    </button>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts{
<script>
        $(document).on('click', 'button[id *= "AddToOrderById_"]',function(e){
            var productId = $(this).data('productid');
            var partialLink = $(this).data('url');
            var orderId = '0';
            var actionUrl = '0';
            $('#MainDiv').append('<div id="ModalHere"></div>');
            var ModalElement = $('#ModalHere');
            $.get(partialLink).done(function (data) {
                ModalElement.html(data);
                ModalElement.find('.modal').modal('show');
            })

            ModalElement.on('click','button[data-bs-dismiss *= "modal"]',function(e){
                ModalElement.find('.modal').modal('hide');
                ModalElement.html(null);
                ModalElement.remove();
            })

            ModalElement.on('click','button[id *= "SelectOrder_"]',function(e){
                orderId = $(this).data('orderid');
                actionUrl = `/Orders?OrderId=${orderId}&ProductId=${productId}&handler=AddProductInOrder`;
                $.get(actionUrl).done(function(e){
                    ModalElement.find('.modal').modal('hide');
                    ModalElement.html(null);
                    ModalElement.remove();
                })
            })
        })

            $(document).on('click','.btn-outline-warning',function (e) {
            $('#MainDiv').append('<div id="ModalHere"></div>');
            var ModalEditElement = $('#ModalHere');
            var url = $(this).data('url');
            $.get(url).done(function (data) {
                ModalEditElement.html(data);
                ModalEditElement.find('.modal').modal('show');
            })


        $(document).on('click','button[data-bs-dismiss *= "modal"]',function(e){
                ModalEditElement.find('.modal').modal('hide');
                ModalEditElement.html(null);
                ModalEditElement.remove();
            })

        ModalEditElement.on('click','#SaveBtn', function(e) {
            var actionUrl = ModalEditElement.find('#ProdEditForm').attr('action');
            var data = ModalEditElement.find('#ProdEditForm').serialize();
            ModalEditElement.off('click', '#SaveBtn');
            $.ajax({
                type: 'post',
                url: actionUrl,
                data: data,
            }).done(function(e){
                        var newBody = $('.modal-body', e);
                    ModalEditElement.find('.modal-body').replaceWith(newBody);
                    var isValid = newBody.find('[name="IsValid"]').val() == 'True';
                    if (isValid) {
                        $.get('/Product').done(function(e){
                            var newbody = $('#typeList', e);
                            $(document).find('#typeList').replaceWith(newbody);
                            ModalEditElement.find('.modal').modal('hide');
                            $('#MainDiv').find('#ModalHere').remove();
                        })
                    }
                    })
              })
        })
        $(document).on('click', '.bi-plus-circle', function (e) {
        $('#MainDiv').append('<div id="ModalHere"></div>');
        var ModalCreateElement = $('#ModalHere');
        var url = $(this).data('createpartial');
        $.get(url).done(function (data) {
            ModalCreateElement.html(data);
            ModalCreateElement.find('.modal').modal('show');
        })
        ModalCreateElement.on('click', '#CancelBtn', function (e) {
            ModalCreateElement.find('.modal').modal('hide');
            $('#MainDiv').find('#ModalHere').remove();
        });

        ModalCreateElement.on('click', '#CreateBtn', function (e) {
            var dataToSend = ModalCreateElement.find('#ProdCreateForm').serialize();
            var crtUrl = ModalCreateElement.find('#ProdCreateForm').attr('action');
            $.ajax({
                type: "POST",
                url: crtUrl,
                data: dataToSend
            }).done(function (e) {
                var newBody = $('.modal-body', e);
                ModalCreateElement.find('.modal-body').replaceWith(newBody);
                var isValid = newBody.find('[name="IsValid"]').val() == 'True';
                if (isValid) {
                    $.get('Product').done(function (e) {
                        var newbody = $('#prodList', e);
                        $(document).find('#prodList').replaceWith(newbody);
                        ModalCreateElement.find('.modal').modal('hide');
                        $('#ModalHere').remove();
                    })
                }
            })
        })
    })
</script>
}